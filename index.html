<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeeCode - Mastery Roadmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Monaco Editor Loader -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs/loader.js"></script>
    <style>
        :root {
            /* Light Mode (High Contrast B&W) */
            --bg-primary: #ffffff;
            --bg-secondary: #f4f4f5; 
            --bg-tertiary: #e4e4e7;
            --text-primary: #000000;
            --text-secondary: #52525b;
            --accent-primary: #000000; 
            --accent-secondary: #27272a;
            --border-color: #000000;
            --correct-color: #000000;
            --incorrect-color: #7f1d1d;
            --font-mono: 'JetBrains Mono', monospace;
        }

        html.dark {
            /* Dark Mode (High Contrast B&W) */
            --bg-primary: #000000;
            --bg-secondary: #121212;
            --bg-tertiary: #27272a;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --accent-primary: #ffffff;
            --accent-secondary: #d4d4d8;
            --border-color: #ffffff;
            --correct-color: #ffffff;
            --incorrect-color: #f87171;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Utility Classes using Vars */
        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-accent { color: var(--accent-primary); }
        .border-themed { border-color: var(--border-color); border-width: 1px; }
        .font-mono { font-family: var(--font-mono); }
        
        /* Interactive Elements */
        .btn-base {
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        .btn-base:hover {
            transform: translateY(-2px);
            box-shadow: 4px 4px 0px var(--border-color);
        }
        .btn-base:active {
            transform: translateY(0);
            box-shadow: 0px 0px 0px var(--border-color);
        }

        .roadmap-item:not(:last-child)::after {
            content: ''; position: absolute; left: 50%; top: 100%;
            width: 2px; height: 2rem; background-color: var(--border-color);
            transform: translateX(-50%);
            z-index: 0;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        .loader-block {
            width: 20px; height: 20px; background-color: var(--accent-primary);
            animation: flip 1s infinite;
        }
        @keyframes flip { 0% { transform: rotateX(0); } 50% { transform: rotateX(180deg); } 100% { transform: rotateX(180deg) rotateY(180deg); } }

        /* Markdown Styles */
        .prose h1, .prose h2, .prose h3 { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 700; color: var(--text-primary); }
        .prose h1 { font-size: 2em; border-bottom: 2px solid var(--border-color); padding-bottom: 0.2em; }
        .prose h2 { font-size: 1.5em; }
        .prose p { margin-bottom: 1em; line-height: 1.6; }
        .prose code { background-color: var(--bg-tertiary); padding: 0.2em 0.4em; font-family: var(--font-mono); font-size: 0.9em; }
        .prose pre { background-color: var(--bg-secondary); padding: 1em; overflow-x: auto; margin-bottom: 1em; border: 1px solid var(--border-color); }
        .prose blockquote { border-left: 4px solid var(--text-primary); padding-left: 1em; font-style: italic; }

        /* Chat Styles */
        .chat-msg { max-width: 80%; padding: 0.75rem; margin-bottom: 0.5rem; border: 1px solid var(--border-color); }
        .chat-user { align-self: flex-end; background-color: var(--bg-tertiary); }
        .chat-ai { align-self: flex-start; background-color: var(--bg-primary); }
    </style>
</head>
<body>

    <div id="app" class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 border-b-2 border-themed pb-6 gap-6">
            <div class="flex flex-col">
                <h1 class="text-5xl font-bold tracking-tighter">DeeCode</h1>
                <p class="text-sm font-mono mt-2 bg-text-primary text-bg-primary inline-block px-2 py-1">MASTER THE CRAFT.</p>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="window.clearData()" class="text-xs hover:underline font-mono uppercase tracking-widest text-secondary">Reset All Data</button>
                <button id="themeToggle" class="btn-base p-3 rounded-none bg-primary text-primary">
                    <span id="theme-text" class="font-bold text-xs uppercase">Theme</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main id="mainContent" class="min-h-screen flex flex-col">
            
            <!-- Tech Selection -->
            <div id="techSelection" class="flex-grow flex flex-col items-center fade-in">
                <h2 class="text-2xl font-bold mb-8 text-center uppercase tracking-wide border-b border-themed pb-2">Select Your Path</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 w-full max-w-6xl pb-10">
                    <!-- Tech buttons injected here -->
                </div>
            </div>

            <!-- Roadmap Container -->
            <div id="roadmapContainer" class="hidden flex flex-col h-full fade-in">
                 <div class="flex flex-wrap items-center justify-between gap-4 mb-10 border-b border-themed pb-4">
                    <div class="flex items-center gap-4">
                        <button id="backButton" class="btn-base bg-primary font-bold py-2 px-6 text-sm uppercase">
                            &larr; Back
                        </button>
                        <div>
                            <h2 id="currentRoadmapTitle" class="text-3xl font-bold uppercase"></h2>
                        </div>
                    </div>
                    <div class="w-full md:w-1/3">
                         <div class="flex justify-between text-xs font-mono mb-1">
                             <span>PROGRESS</span>
                             <span id="progressText">0%</span>
                         </div>
                        <div class="w-full border border-themed h-4 p-0.5">
                            <div id="roadmapProgressBar" class="bg-text-primary h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                 </div>
                <div id="roadmapContent" class="pb-20 max-w-4xl mx-auto"></div>
            </div>
        </main>
        
        <!-- Modal -->
        <div id="contentModal" class="hidden fixed inset-0 bg-bg-primary/95 z-50 flex justify-center items-center p-0 md:p-6 backdrop-blur-sm">
            <div id="modal-container" class="bg-primary w-full max-w-6xl h-full md:h-[90vh] flex flex-col border-2 border-themed shadow-2xl relative">
                
                <!-- Modal Header -->
                <div class="flex justify-between items-center p-4 border-b border-themed bg-secondary">
                    <h2 id="modalTitle" class="text-xl md:text-2xl font-bold truncate pr-4 uppercase tracking-tight"></h2>
                    <div class="flex items-center gap-3">
                        <button onclick="window.exportTopicToHTML()" class="btn-base flex items-center gap-2 bg-primary px-3 py-1 text-xs font-bold uppercase" title="Download Offline Copy">
                            <span>Save .html</span>
                        </button>
                        <button id="markCompleteBtn" class="btn-base flex items-center gap-2 bg-primary px-3 py-1 text-xs font-bold uppercase">
                            <span>Mark Done</span>
                        </button>
                        <button id="closeModal" class="hover:bg-text-primary hover:text-bg-primary p-1 transition-colors border border-transparent hover:border-themed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex border-b border-themed overflow-x-auto">
                    <button id="conceptTab" class="flex-1 min-w-[100px] py-4 text-sm font-bold uppercase border-r border-themed hover:bg-secondary transition-colors">Concept</button>
                    <button id="practiceTab" class="flex-1 min-w-[100px] py-4 text-sm font-bold uppercase border-r border-themed hover:bg-secondary transition-colors">Practice</button>
                    <button id="quizTab" class="flex-1 min-w-[100px] py-4 text-sm font-bold uppercase border-r border-themed hover:bg-secondary transition-colors">Quiz</button>
                    <button id="bankTab" class="flex-1 min-w-[100px] py-4 text-sm font-bold uppercase border-r border-themed hover:bg-secondary transition-colors flex items-center justify-center gap-2">
                         <span>Bank</span>
                         <span class="text-[10px] border border-current px-1 rounded-full opacity-70">SAVED</span>
                    </button>
                    <button id="tutorTab" class="flex-1 min-w-[100px] py-4 text-sm font-bold uppercase hover:bg-secondary transition-colors flex items-center justify-center gap-2">
                        <span>AI Tutor</span>
                    </button>
                </div>

                <!-- Content Area -->
                <div id="modalContent" class="p-6 overflow-y-auto flex-grow relative bg-primary font-mono text-sm leading-relaxed">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>
        
        <!-- Loading Overlay -->
        <div id="loader" class="fixed inset-0 bg-bg-primary/95 z-[60] flex flex-col justify-center items-center hidden">
             <div class="loader-block mb-6"></div>
             <p id="loaderText" class="font-mono text-lg uppercase tracking-widest">Processing...</p>
        </div>

        <!-- Error Toast -->
        <div id="errorMessage" class="hidden fixed bottom-5 right-5 max-w-sm bg-incorrect-color text-white px-6 py-4 border-2 border-black z-[70] font-bold shadow-xl"></div>

    </div>

    <script type="module">
        // --- Configuration ---
        const apiKey = ''; 
        
        // Comprehensive Subject List
        const subjectList = [
            "HTML", "CSS", "JavaScript", "TypeScript", "React", "Redux", "Node.js", "Express.js", 
            "SQL", "MySQL", "MongoDB", "API", "System Design", "Interview Prep", "Python", 
            "DSA", "AI", "ML", "NLP", "Cloud Computing", "DevOps", "Data Science", 
            "Data Analytics", "Cybersecurity", "Ethical Hacking", "AI & Automation", 
            "DSA with C++", "DSA with Java", "Advance DSA", "Projects", "Neural Network", 
            "MAANG", "FAANG", "Advance Projects", "Job Ready Projects", "Real World Projects", "Futuristic Projects"
        ];

        // --- State ---
        let currentTopic = null;
        let currentTechnology = null;
        let monacoEditorInstance = null;
        let currentTopicCache = {}; 
        let quizState = { questions: [], currentQuestionIndex: 0, score: 0 };
        let progress = {};
        let questionBank = {}; // { Technology: { Topic: { quiz: [], practice: [] } } }
        let currentRoadmapData = [];
        let chatHistory = [];

        // --- Storage Keys ---
        const STORAGE_KEYS = {
            PROGRESS: 'deecode_progress',
            ROADMAP_PREFIX: 'deecode_map_',
            CONTENT_PREFIX: 'deecode_content_',
            QUESTION_BANK: 'deecode_bank'
        };

        // --- DOM Elements ---
        const els = {
            techSelection: document.getElementById('techSelection'),
            roadmapContainer: document.getElementById('roadmapContainer'),
            roadmapContent: document.getElementById('roadmapContent'),
            currentRoadmapTitle: document.getElementById('currentRoadmapTitle'),
            roadmapProgressBar: document.getElementById('roadmapProgressBar'),
            progressText: document.getElementById('progressText'),
            modal: document.getElementById('contentModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalContent'),
            loader: document.getElementById('loader'),
            loaderText: document.getElementById('loaderText'),
            error: document.getElementById('errorMessage'),
            markCompleteBtn: document.getElementById('markCompleteBtn'),
            tabs: {
                concept: document.getElementById('conceptTab'),
                practice: document.getElementById('practiceTab'),
                quiz: document.getElementById('quizTab'),
                bank: document.getElementById('bankTab'),
                tutor: document.getElementById('tutorTab')
            }
        };

        // --- Local Storage Helpers ---
        function loadLocalData() {
            try {
                const savedProgress = localStorage.getItem(STORAGE_KEYS.PROGRESS);
                if (savedProgress) progress = JSON.parse(savedProgress);
                
                const savedBank = localStorage.getItem(STORAGE_KEYS.QUESTION_BANK);
                if (savedBank) questionBank = JSON.parse(savedBank);
            } catch (e) { console.error(e); }
        }

        function saveLocalProgress() {
            try { localStorage.setItem(STORAGE_KEYS.PROGRESS, JSON.stringify(progress)); } catch (e) { }
        }

        function saveQuestionBank() {
            try { localStorage.setItem(STORAGE_KEYS.QUESTION_BANK, JSON.stringify(questionBank)); } catch (e) { console.warn('Storage full'); }
        }

        function getCached(key) {
            try { return JSON.parse(localStorage.getItem(key)); } catch (e) { return null; }
        }

        function setCached(key, data) {
            try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { console.warn('Storage full'); }
        }

        window.clearData = () => {
            if(confirm("RESET DEECODE?\nThis will wipe all progress, question banks, and downloaded roadmaps.")) {
                localStorage.clear();
                window.location.reload();
            }
        };

        // --- API Interaction ---
        async function fetchGemini(prompt, isJson = false) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // System instruction for consistent "Senior Engineer" persona
            const systemInstruction = {
                role: "user",
                parts: [{ text: "You are DeeCode, a Senior Principal Engineer and mentor. Your goal is to explain complex technical concepts in simple, easy-to-understand terms while maintaining industry standards. Use analogies, clear examples, and highlight tips for fast learning. Use 'I' when teaching." }]
            };

            const payload = { 
                contents: [
                    systemInstruction,
                    { role: "user", parts: [{ text: prompt }] }
                ],
                generationConfig: isJson ? { responseMimeType: "application/json" } : {} 
            };

            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                if (!res.ok) throw new Error("API Error");
                const data = await res.json();
                let text = data.candidates[0].content.parts[0].text;
                
                if (isJson) {
                    // Sanitize markdown code blocks if present
                    text = text.replace(/```json\n?|```/g, '').trim();
                    return JSON.parse(text);
                }
                return text;
            } catch (e) {
                console.error(e);
                throw e;
            }
        }

        // --- Core Application Logic ---

        // 1. Initial Render
        function init() {
            loadLocalData();
            const grid = els.techSelection.querySelector('.grid');
            grid.innerHTML = subjectList.map(tech => `
                <button onclick="window.loadRoadmap('${tech}')" class="btn-base group bg-secondary p-8 flex flex-col items-center justify-center gap-4 h-40 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-2 opacity-10 font-black text-6xl select-none group-hover:opacity-20 transition-opacity">${tech.substring(0,1)}</div>
                    <h3 class="text-xl font-bold z-10 text-center uppercase tracking-wider">${tech}</h3>
                </button>
            `).join('');
        }

        // 2. Load Roadmap
        window.loadRoadmap = async (tech) => {
            currentTechnology = tech;
            els.techSelection.classList.add('hidden');
            els.roadmapContainer.classList.remove('hidden');
            els.currentRoadmapTitle.textContent = tech;

            const cacheKey = STORAGE_KEYS.ROADMAP_PREFIX + tech;
            const cached = getCached(cacheKey);

            if (cached) {
                renderRoadmap(cached);
            } else {
                showLoader(true, `Architecting ${tech} Path...`);
                try {
                    // UPDATED PROMPT: W3Schools style exhaustive syllabus
                    const prompt = `Generate an extremely detailed, exhaustive learning roadmap for ${tech}, modeled strictly after the comprehensive syllabus structure of w3schools.
                    It must be a "Zero to Hero" guide covering every single syntax element, core concept, and advanced feature.

                    Organize the content into specific, granular modules (e.g., "${tech} Syntax", "${tech} Variables", "${tech} Arrays", "${tech} Async", "${tech} DOM/API").
                    
                    The roadmap should include (adapted for ${tech}):
                    - Basics: Syntax, Comments, Variables, Operators, Data Types.
                    - Control Flow: If/Else, Switch, Loops (For, While), Break/Continue.
                    - Functions: Definitions, Parameters, Invocation, Closures, Arrow Functions.
                    - Objects/Classes: Properties, Methods, Constructors, Inheritance, Prototypes.
                    - Advanced: Async/Await, Promises, Modules, Error Handling, Debugging.
                    - Standard Library/API: Math, Dates, JSON, RegExp, Collections (Maps/Sets).
                    - Ecosystem: Versions, Tools, Best Practices.

                    Return ONLY a valid JSON array of objects: 
                    [{ "title": "Module Title", "subtopics": ["Specific Topic 1", "Specific Topic 2", ...] }]
                    
                    Ensure the output is extensive (20+ modules) to serve as a complete reference manual.`;
                    
                    const data = await fetchGemini(prompt, true);
                    setCached(cacheKey, data);
                    renderRoadmap(data);
                } catch (err) {
                    showError("Connection failed. Try again.");
                    els.techSelection.classList.remove('hidden');
                    els.roadmapContainer.classList.add('hidden');
                } finally {
                    showLoader(false);
                }
            }
        };

        function renderRoadmap(data) {
            currentRoadmapData = data;
            els.roadmapContent.innerHTML = '';
            const completedList = progress[currentTechnology] || [];

            // Draw line
            const line = document.createElement('div');
            line.className = "absolute left-4 md:left-1/2 top-0 bottom-0 w-0.5 bg-border-color transform md:-translate-x-1/2 z-0";
            els.roadmapContent.appendChild(line);

            data.forEach((topic, idx) => {
                const isCompleted = completedList.includes(topic.title);
                const isRight = idx % 2 === 0;
                
                const item = document.createElement('div');
                item.className = `relative w-full mb-12 flex ${isRight ? 'md:justify-start' : 'md:justify-end'} justify-end pl-12 md:pl-0 fade-in`;
                item.style.animationDelay = `${idx * 0.05}s`;

                item.innerHTML = `
                    <!-- Center Node -->
                    <div class="absolute left-4 md:left-1/2 w-4 h-4 bg-bg-primary border-2 border-border-color transform -translate-x-1/2 mt-6 z-10 ${isCompleted ? 'bg-text-primary' : ''}"></div>
                    
                    <!-- Content Card -->
                    <div class="w-full md:w-[45%] btn-base bg-bg-primary p-6 relative ${isRight ? 'md:mr-8' : 'md:ml-8'}">
                        <button onclick="window.openTopic('${topic.title}')" class="w-full text-left">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-lg font-bold uppercase leading-tight">${topic.title}</h3>
                                ${isCompleted ? '<span class="text-[10px] bg-text-primary text-bg-primary px-1 font-mono">DONE</span>' : ''}
                            </div>
                            <p class="text-xs text-text-secondary font-mono mb-4">${topic.subtopics.length} Modules</p>
                            
                            <!-- Mini Subtopic List -->
                            <div class="space-y-1">
                                ${topic.subtopics.slice(0, 3).map(sub => `
                                    <div class="flex items-center gap-2 text-xs text-text-secondary">
                                        <div class="w-1 h-1 bg-text-secondary"></div>
                                        <span>${sub}</span>
                                    </div>
                                `).join('')}
                                ${topic.subtopics.length > 3 ? `<div class="text-xs text-text-secondary pl-3">... +${topic.subtopics.length - 3} more</div>` : ''}
                            </div>
                        </button>
                    </div>
                `;
                els.roadmapContent.appendChild(item);
            });
            updateProgress();
        }

        // 3. Topic Modal & Tabs
        window.openTopic = (topic) => {
            currentTopic = topic;
            currentTopicCache = {}; 
            chatHistory = []; // Reset chat for new topic
            els.modalTitle.textContent = topic;
            updateMarkCompleteBtn();
            els.modal.classList.remove('hidden');
            switchTab('concept');
        };

        window.switchTab = (tab) => {
            // UI Update
            Object.values(els.tabs).forEach(t => t.classList.remove('bg-text-primary', 'text-bg-primary'));
            els.tabs[tab].classList.add('bg-text-primary', 'text-bg-primary');
            
            renderTabContent(tab);
        }

        window.forceGenerate = (tab) => {
            // Bypass cache and force API call
            renderTabContent(tab, true);
        };

        async function renderTabContent(tab, forceRefresh = false) {
            els.modalContent.innerHTML = ''; 

            // Special Tab Handling
            if (tab === 'tutor') {
                renderChatInterface();
                return;
            }
            if (tab === 'bank') {
                renderQuestionBank();
                return;
            }

            // Standard Content Handling (Cached)
            const cacheKey = `${STORAGE_KEYS.CONTENT_PREFIX}${currentTechnology}_${currentTopic}_${tab}`;
            const cached = getCached(cacheKey);

            if (cached && !forceRefresh) {
                currentTopicCache[tab] = cached; 
                injectContent(tab, cached);
                return;
            }

            // Generate
            els.modalContent.innerHTML = `<div class="flex flex-col items-center justify-center py-20"><div class="loader-block mb-4"></div><p class="font-mono text-sm">GENERATING ${tab === 'quiz' ? '20 SCENARIO QUESTIONS' : 'UNIQUE CHALLENGE'}...</p></div>`;

            try {
                let prompt, data;
                if (tab === 'concept') {
                    prompt = `Explain "${currentTopic}" in ${currentTechnology} clearly and comprehensively.
                    Structure your response as follows:
                    1. **The Simple Explanation**: Easy-to-understand definition using real-world analogies.
                    2. **Deep Dive & Examples**: Technical explanation with clear, well-commented code examples.
                    3. **Important Highlights**: Bullet points of critical concepts to remember.
                    4. **Pro Tips & Tricks**: Shortcuts, common pitfalls, and guides to learn this fast.
                    5. **Interview Focus**: Why this matters for your job search.
                    Format: Markdown. Use bold text for emphasis.`;
                    data = await fetchGemini(prompt);
                } else if (tab === 'practice') {
                    prompt = `Create a unique, Senior-level coding challenge for ${currentTopic} in ${currentTechnology}. 
                    Focus on real-world system design or optimization. 
                    JSON Format: { "problem": "Detailed real-world scenario description", "hint": "Architectural tip", "solution": "Full code solution" }`;
                    data = await fetchGemini(prompt, true);
                    
                    // Add to Bank
                    addToBank('practice', data);
                } else if (tab === 'quiz') {
                    prompt = `Generate 20 distinct, conceptual, and scenario-based multiple-choice questions for ${currentTopic} in ${currentTechnology}. 
                    Focus on edge cases, production issues, and advanced patterns. 
                    JSON Format: Array of { "q": "Question text", "o": ["A", "B", "C", "D"], "a": "Exact answer string", "e": "Explanation" }`;
                    data = await fetchGemini(prompt, true);
                    
                    // Add to Bank
                    addToBank('quiz', data);
                }

                setCached(cacheKey, data);
                currentTopicCache[tab] = data;
                injectContent(tab, data);
            } catch (e) {
                console.error(e);
                els.modalContent.innerHTML = `<div class="text-center p-10 text-incorrect-color font-bold">GENERATION FAILED (Check API/Network).<br><button onclick="window.forceGenerate('${tab}')" class="underline mt-2">RETRY</button></div>`;
            }
        }

        // --- Question Bank Logic ---
        function addToBank(type, data) {
            // Ensure structure exists
            if (!questionBank[currentTechnology]) questionBank[currentTechnology] = {};
            if (!questionBank[currentTechnology][currentTopic]) questionBank[currentTechnology][currentTopic] = { quiz: [], practice: [] };

            if (type === 'quiz') {
                // Flatten array if necessary and append
                const questions = Array.isArray(data) ? data : [data];
                questionBank[currentTechnology][currentTopic]['quiz'].push(...questions);
            } else if (type === 'practice') {
                questionBank[currentTechnology][currentTopic]['practice'].push(data);
            }
            saveQuestionBank();
        }

        function renderQuestionBank() {
            const bank = questionBank[currentTechnology]?.[currentTopic];
            
            if (!bank || (!bank.quiz.length && !bank.practice.length)) {
                els.modalContent.innerHTML = `<div class="text-center py-20 opacity-50 font-mono">NO SAVED QUESTIONS YET.<br>GENERATE CONTENT IN PRACTICE OR QUIZ TABS.</div>`;
                return;
            }

            const quizCount = bank.quiz.length;
            const practiceCount = bank.practice.length;

            els.modalContent.innerHTML = `
                <div class="max-w-4xl mx-auto space-y-8">
                    <div class="border-b border-themed pb-4 mb-4">
                        <h2 class="text-2xl font-bold uppercase">Topic Vault</h2>
                        <p class="text-xs font-mono opacity-70">TOTAL SAVED: ${quizCount} QUESTIONS | ${practiceCount} CHALLENGES</p>
                    </div>

                    ${practiceCount > 0 ? `
                        <div>
                            <h3 class="font-bold text-lg mb-4 bg-secondary p-2 border border-themed">CODING CHALLENGES</h3>
                            <div class="space-y-4">
                                ${bank.practice.map((p, i) => `
                                    <div class="border border-themed p-4 hover:bg-bg-secondary transition-colors cursor-pointer" onclick="window.loadSavedPractice(${i})">
                                        <div class="font-bold text-sm mb-1">CHALLENGE #${i+1}</div>
                                        <div class="text-xs opacity-70 line-clamp-2">${p.problem.substring(0, 150)}...</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${quizCount > 0 ? `
                        <div>
                            <h3 class="font-bold text-lg mb-4 bg-secondary p-2 border border-themed">QUIZ QUESTIONS</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${bank.quiz.map((q, i) => `
                                    <div class="border border-themed p-3 text-xs">
                                        <div class="font-bold mb-1">Q${i+1}: ${q.q}</div>
                                        <div class="opacity-70 mt-1">Ans: ${q.a}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        window.loadSavedPractice = (index) => {
             const data = questionBank[currentTechnology][currentTopic].practice[index];
             // Cache this as the current practice to prevent switchTab from loading a different cached version
             const cacheKey = `${STORAGE_KEYS.CONTENT_PREFIX}${currentTechnology}_${currentTopic}_practice`;
             setCached(cacheKey, data);
             currentTopicCache['practice'] = data;
             // Switch to practice tab and inject this data
             switchTab('practice');
        };

        function injectContent(tab, data) {
            els.modalContent.innerHTML = '';
            
            if (tab === 'concept') {
                const div = document.createElement('div');
                div.className = 'prose prose-invert max-w-none';
                div.innerHTML = parseMarkdown(data);
                els.modalContent.appendChild(div);
            } 
            else if (tab === 'practice') {
                els.modalContent.innerHTML = `
                    <div class="flex flex-col h-full min-h-[500px]">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold uppercase">The Challenge</h3>
                            <button onclick="window.forceGenerate('practice')" class="btn-base px-3 py-1 text-xs font-bold uppercase bg-bg-secondary hover:bg-text-primary hover:text-bg-primary transition-colors">Generate New</button>
                        </div>
                        <div class="bg-secondary p-4 border border-themed mb-4">
                            <p class="whitespace-pre-wrap">${data.problem}</p>
                        </div>
                        <div class="flex-grow border border-themed relative" style="min-height: 400px;">
                            <div id="editor-container" class="absolute inset-0"></div>
                        </div>
                        <div class="mt-4 flex gap-4">
                            <button onclick="document.getElementById('hint').classList.toggle('hidden')" class="btn-base px-4 py-2 text-xs font-bold uppercase">Hint</button>
                            <button onclick="window.showSol()" class="btn-base px-4 py-2 text-xs font-bold uppercase bg-text-primary text-bg-primary">Solution</button>
                        </div>
                        <div id="hint" class="hidden mt-4 p-4 bg-tertiary text-xs font-mono border-l-2 border-text-primary">${data.hint}</div>
                    </div>
                `;
                initMonaco();
                window.showSol = () => monacoEditorInstance?.setValue(data.solution);
            } 
            else if (tab === 'quiz') {
                quizState.questions = data;
                quizState.currentQuestionIndex = 0;
                quizState.score = 0;
                renderQuiz();
            }
        }

        // 4. Chat / AI Tutor Logic
        function renderChatInterface() {
            els.modalContent.innerHTML = `
                <div class="flex flex-col h-full" style="height: 65vh;">
                    <div id="chat-history" class="flex-grow overflow-y-auto p-4 space-y-4 border border-themed bg-secondary">
                        <div class="chat-msg chat-ai rounded-none border border-themed">
                            <p class="font-bold mb-1">DEECODE TUTOR</p>
                            <p>I am ready to help you master ${currentTopic}. Ask me anything about implementation, edge cases, or interview tricks.</p>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <input type="text" id="chat-input" class="flex-grow p-3 bg-primary border border-themed font-mono text-sm focus:outline-none focus:ring-2 focus:ring-text-primary" placeholder="Ask a question..." onkeypress="if(event.key==='Enter') window.sendChat()">
                        <button onclick="window.sendChat()" class="btn-base px-6 font-bold uppercase bg-text-primary text-bg-primary">Send</button>
                    </div>
                </div>
            `;
            // Restore history if needed, for now just fresh
            chatHistory.forEach(msg => appendChatMsg(msg.role, msg.text));
        }

        window.sendChat = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            input.value = '';
            appendChatMsg('user', text);
            chatHistory.push({ role: 'user', parts: [{ text: text }] });

            // Create placeholder
            const historyDiv = document.getElementById('chat-history');
            const loadingId = 'chat-loading-' + Date.now();
            historyDiv.insertAdjacentHTML('beforeend', `
                <div id="${loadingId}" class="chat-msg chat-ai font-mono text-xs animate-pulse">Thinking...</div>
            `);
            historyDiv.scrollTop = historyDiv.scrollHeight;

            try {
                // Contextual prompt
                const prompt = `Context: Teaching ${currentTopic} in ${currentTechnology}. User asks: ${text}. Keep answer short and technical.`;
                const reply = await fetchGemini(prompt);
                
                document.getElementById(loadingId).remove();
                appendChatMsg('model', reply);
                chatHistory.push({ role: 'model', parts: [{ text: reply }] });
            } catch (e) {
                document.getElementById(loadingId).innerText = "Error connecting to tutor.";
            }
        };

        function appendChatMsg(role, text) {
            const div = document.getElementById('chat-history');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-msg ${role === 'user' ? 'chat-user ml-auto' : 'chat-ai mr-auto'}`;
            msgDiv.innerHTML = role === 'model' ? parseMarkdown(text) : `<p>${text}</p>`;
            div.appendChild(msgDiv);
            div.scrollTop = div.scrollHeight;
        }

        // 5. Offline Export Logic (.html file generation)
        window.exportTopicToHTML = async () => {
            showLoader(true, "Packaging Content...");
            
            // Ensure we have data (load if not cached)
            const conceptKey = `${STORAGE_KEYS.CONTENT_PREFIX}${currentTechnology}_${currentTopic}_concept`;
            let concept = getCached(conceptKey);
            if (!concept) {
                // Fetch if missing
                try {
                     const prompt = `Write a comprehensive technical guide on "${currentTopic}" in ${currentTechnology}. Format: Markdown.`;
                     concept = await fetchGemini(prompt);
                     setCached(conceptKey, concept);
                } catch(e) {
                    showError("Cannot export: content not generated.");
                    showLoader(false);
                    return;
                }
            }

            // Create HTML Blob
            const htmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DeeCode: ${currentTopic}</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 2rem; color: #333; }
        h1 { border-bottom: 2px solid #000; padding-bottom: 10px; }
        code { background: #f4f4f4; padding: 2px 5px; }
        pre { background: #f4f4f4; padding: 15px; overflow-x: auto; border: 1px solid #ddd; }
        .footer { margin-top: 50px; font-size: 0.8em; color: #888; border-top: 1px solid #ddd; padding-top: 10px; }
    </style>
</head>
<body>
    <h1>${currentTechnology}: ${currentTopic}</h1>
    <div class="content">
        ${parseMarkdown(concept)}
    </div>
    <div class="footer">
        Generated by DeeCode. Job Ready Mastery.
    </div>
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DeeCode_${currentTechnology}_${currentTopic.replace(/\s+/g, '_')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showLoader(false);
        };

        // --- Helpers ---
        function updateMarkCompleteBtn() {
            const list = progress[currentTechnology] || [];
            if(list.includes(currentTopic)) {
                els.markCompleteBtn.innerHTML = "<span>COMPLETED</span>";
                els.markCompleteBtn.classList.add('bg-text-primary', 'text-bg-primary');
                els.markCompleteBtn.disabled = true;
            } else {
                els.markCompleteBtn.innerHTML = "<span>MARK DONE</span>";
                els.markCompleteBtn.classList.remove('bg-text-primary', 'text-bg-primary');
                els.markCompleteBtn.disabled = false;
            }
        }

        function updateProgress() {
            const total = currentRoadmapData.length;
            const done = (progress[currentTechnology] || []).length;
            const pct = Math.round((done/total) * 100) || 0;
            els.roadmapProgressBar.style.width = `${pct}%`;
            els.progressText.innerText = `${pct}% MASTERY`;
        }

        function parseMarkdown(md) {
            return md
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/`([^`]+)`/gim, '<code>$1</code>')
                .replace(/```([\s\S]*?)```/gim, '<pre><code>$1</code></pre>')
                .replace(/^\- (.*$)/gim, '<ul><li>$1</li></ul>')
                .replace(/\n/gim, '<br>');
        }

        // Quiz Logic
        function renderQuiz() {
            if(quizState.currentQuestionIndex >= quizState.questions.length) {
                els.modalContent.innerHTML = `<div class="text-center py-10"><h2 class="text-3xl font-bold mb-4">SCORE: ${quizState.score}/${quizState.questions.length}</h2><button onclick="window.forceGenerate('quiz')" class="btn-base px-6 py-2 uppercase font-bold mr-4">New Set</button><button onclick="window.restartQuiz()" class="btn-base px-6 py-2 uppercase font-bold">Retry</button></div>`;
                return;
            }
            // Add generate new button to quiz view
            const header = `
                <div class="flex justify-between items-center mb-6">
                    <div class="text-xs font-mono">QUESTION ${quizState.currentQuestionIndex + 1} OF ${quizState.questions.length}</div>
                    <button onclick="window.forceGenerate('quiz')" class="btn-base px-3 py-1 text-xs font-bold uppercase bg-bg-secondary hover:bg-text-primary hover:text-bg-primary transition-colors">Generate New</button>
                </div>
            `;
            
            const q = quizState.questions[quizState.currentQuestionIndex];
            els.modalContent.innerHTML = `
                <div class="max-w-2xl mx-auto py-6">
                    ${header}
                    <h3 class="text-xl font-bold mb-6">${q.q}</h3>
                    <div class="space-y-3">
                        ${q.o.map(opt => `<button onclick="window.checkAns(this, '${opt.replace(/'/g,"\\'")}')" class="w-full text-left p-4 border border-themed hover:bg-bg-tertiary transition-colors font-mono text-sm">${opt}</button>`).join('')}
                    </div>
                    <div id="q-feedback" class="hidden mt-6 p-4 border border-themed bg-secondary"></div>
                    <button id="q-next" onclick="window.nextQ()" class="hidden mt-4 w-full btn-base py-3 font-bold bg-text-primary text-bg-primary">NEXT</button>
                </div>
            `;
        }
        
        window.checkAns = (btn, val) => {
            const q = quizState.questions[quizState.currentQuestionIndex];
            const isCorrect = val === q.a;
            if(isCorrect) quizState.score++;
            
            document.querySelectorAll('#modalContent button:not(#q-next)').forEach(b => b.disabled = true);
            const feed = document.getElementById('q-feedback');
            feed.innerHTML = `<p class="font-bold mb-1">${isCorrect ? 'CORRECT' : 'INCORRECT'}</p><p>${q.e}</p>`;
            feed.classList.remove('hidden');
            feed.style.borderColor = isCorrect ? 'var(--text-primary)' : 'var(--incorrect-color)';
            document.getElementById('q-next').classList.remove('hidden');
        };
        window.nextQ = () => { quizState.currentQuestionIndex++; renderQuiz(); };
        window.restartQuiz = () => { quizState.currentQuestionIndex = 0; quizState.score = 0; renderQuiz(); };

        // Monaco Init
        function initMonaco() {
            setTimeout(() => {
                const c = document.getElementById('editor-container');
                if(!c) return;
                
                // Safe dispose
                if(monacoEditorInstance) {
                    try { monacoEditorInstance.dispose(); } catch(e) {}
                    monacoEditorInstance = null;
                }

                if (typeof require !== 'undefined') {
                    require(['vs/editor/editor.main'], () => {
                        monacoEditorInstance = monaco.editor.create(c, {
                            value: '// Code here...',
                            language: 'javascript',
                            theme: document.documentElement.classList.contains('dark') ? 'vs-dark' : 'vs',
                            minimap: { enabled: false },
                            fontFamily: 'JetBrains Mono',
                            fontSize: 14,
                            automaticLayout: true
                        });
                    });
                }
            }, 100);
        }

        // --- Event Listeners ---
        els.tabs.concept.onclick = () => switchTab('concept');
        els.tabs.practice.onclick = () => switchTab('practice');
        els.tabs.quiz.onclick = () => switchTab('quiz');
        els.tabs.bank.onclick = () => switchTab('bank');
        els.tabs.tutor.onclick = () => switchTab('tutor');

        document.getElementById('themeToggle').onclick = () => {
            document.documentElement.classList.toggle('dark');
            if(monacoEditorInstance) monaco.editor.setTheme(document.documentElement.classList.contains('dark') ? 'vs-dark' : 'vs');
        };
        document.getElementById('backButton').onclick = () => { els.roadmapContainer.classList.add('hidden'); els.techSelection.classList.remove('hidden'); };
        document.getElementById('closeModal').onclick = () => els.modal.classList.add('hidden');
        
        els.markCompleteBtn.onclick = () => {
            if(!progress[currentTechnology]) progress[currentTechnology] = [];
            progress[currentTechnology].push(currentTopic);
            saveLocalProgress();
            updateMarkCompleteBtn();
            renderRoadmap(currentRoadmapData);
        };

        // --- Helpers ---
        function showError(msg) { els.error.textContent = msg; els.error.classList.remove('hidden'); setTimeout(()=>els.error.classList.add('hidden'), 3000); }
        function showLoader(show, text) { els.loaderText.textContent = text||"Loading..."; els.loader.classList.toggle('hidden', !show); }

        // Start
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs' }});
        init();

    </script>
</body>
</html>
